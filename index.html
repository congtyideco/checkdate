<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∑ ·ª®ng d·ª•ng ch·ª•p & l∆∞u ·∫£nh (N√¢ng cao)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f9f9f9;
        }
        h2, h3 {
            color: #333;
        }
        #camera-btn {
            font-size: 48px;
            cursor: pointer;
            color: #333;
            text-align: center;
            margin: 20px 0;
            user-select: none;
        }
        #video {
            width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }
        #preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            display: none;
            margin: 20px 0;
            border: 2px dashed #ccc;
            border-radius: 8px;
        }
        #file-input {
            display: none;
        }
        .btn {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        #save-btn { background: #4CAF50; color: white; }
        #delete-btn { background: #f44336; color: white; }
        #refresh-btn { background: #2196F3; color: white; margin-top: 10px; }
        #search-input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        #gallery {
            margin-top: 20px;
        }
        .photo-item {
            background: white;
            border: 1px solid #eee;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .photo-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 5px;
        }
        .photo-info {
            flex: 1;
        }
        .photo-actions button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 14px;
        }

        /* Loading */
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 20px 0;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 8px;
        }
        .pagination button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Toast th√¥ng b√°o */
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            white-space: nowrap;
        }
        #toast.show {
            transform: translateX(0);
        }
        .toast-success { background: #4CAF50; }
        .toast-error { background: #f44336; }
    </style>
</head>
<body>

    <h2>üì∑ ·ª®ng d·ª•ng ch·ª•p & l∆∞u ·∫£nh</h2>

    <!-- Bi·ªÉu t∆∞·ª£ng camera -->
    <div id="camera-btn">üì∑</div>

    <!-- Video stream t·ª´ camera -->
    <video id="video" autoplay playsinline style="display:none;"></video>

    <!-- N√∫t ch·ª•p -->
    <button id="capture-btn" class="btn" style="display:none;">üì∏ Ch·ª•p ·∫£nh</button>

    <!-- Preview ·∫£nh sau khi ch·ª•p ho·∫∑c ch·ªçn -->
    <img id="preview" />

    <!-- N√∫t ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán -->
    <button id="select-btn" class="btn">üìÇ Ch·ªçn ·∫£nh t·ª´ thi·∫øt b·ªã</button>
    <input type="file" id="file-input" accept="image/*">

    <!-- Form l∆∞u ·∫£nh -->
    <div id="save-form" style="display:none; margin: 20px 0; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <input type="text" id="photo-name" placeholder="T√™n ·∫£nh" required><br><br>
        <input type="date" id="photo-date" required><br><br>
        <button id="save-btn" class="btn">üíæ L∆∞u ·∫£nh</button>
        <button id="delete-btn" class="btn">üóëÔ∏è X√≥a & l√†m l·∫°i</button>
    </div>

    <!-- T√¨m ki·∫øm -->
    <input type="text" id="search-input" placeholder="üîç T√¨m theo t√™n ho·∫∑c ng√†y (yyyy-mm-dd)...">

    <!-- N√∫t l√†m m·ªõi -->
    <button id="refresh-btn" class="btn">üîÑ L√†m m·ªõi danh s√°ch</button>

    <!-- Danh s√°ch ·∫£nh ƒë√£ l∆∞u -->
    <h3>üìÅ ·∫¢nh ƒë√£ l∆∞u:</h3>
    <div id="gallery"></div>

    <!-- Ph√¢n trang -->
    <div class="pagination" id="pagination"></div>

    <!-- Loading -->
    <div id="loading" class="loading" style="display:none;">ƒêang t·∫£i...</div>

    <!-- Toast th√¥ng b√°o -->
    <div id="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
      const firebaseConfig = {
  apiKey: "AIzaSyDieqE3UHMnT9QP7wzAHZYx1IJDFHgVPJ0",
  authDomain: "chupanh-970ef.firebaseapp.com",
  projectId: "chupanh-970ef",
  storageBucket: "chupanh-970ef.firebasestorage.app",
  messagingSenderId: "229902106831",
  appId: "1:229902106831:web:fd3c1c1381466bca1bb7ba",
  measurementId: "G-4Y1730XHMZ"
};

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentStream = null;
        let capturedImage = null;
        let allPhotos = []; // l∆∞u to√†n b·ªô ·∫£nh ƒë√£ t·∫£i
        let currentPage = 1;
        const itemsPerPage = 5;
        let isProcessing = false; // tr√°nh double click

        // DOM Elements
        const cameraBtn = document.getElementById('camera-btn');
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('capture-btn');
        const preview = document.getElementById('preview');
        const selectBtn = document.getElementById('select-btn');
        const fileInput = document.getElementById('file-input');
        const saveForm = document.getElementById('save-form');
        const photoName = document.getElementById('photo-name');
        const photoDate = document.getElementById('photo-date');
        const saveBtn = document.getElementById('save-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const gallery = document.getElementById('gallery');
        const searchInput = document.getElementById('search-input');
        const refreshBtn = document.getElementById('refresh-btn');
        const paginationEl = document.getElementById('pagination');
        const loadingEl = document.getElementById('loading');
        const toastEl = document.getElementById('toast');

        // Hi·ªÉn th·ªã toast th√¥ng b√°o
        function showToast(message, isError = false) {
            toastEl.textContent = message;
            toastEl.className = isError ? 'toast-error' : 'toast-success';
            toastEl.classList.add('show');
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }

        // B·∫≠t camera
        cameraBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                currentStream = stream;
                video.style.display = 'block';
                captureBtn.style.display = 'block';
                cameraBtn.style.display = 'none';
            } catch (err) {
                showToast('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + err.message, true);
            }
        });

        // Ch·ª•p ·∫£nh
        captureBtn.addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            capturedImage = canvas.toDataURL('image/png');

            // D·ª´ng camera
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            video.style.display = 'none';
            captureBtn.style.display = 'none';

            // Hi·ªÉn th·ªã ·∫£nh
            preview.src = capturedImage;
            preview.style.display = 'block';
            saveForm.style.display = 'block';
        });

        // Ch·ªçn ·∫£nh t·ª´ thi·∫øt b·ªã
        selectBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (ev) => {
                    capturedImage = ev.target.result;
                    preview.src = capturedImage;
                    preview.style.display = 'block';
                    saveForm.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // L∆∞u ·∫£nh
        saveBtn.addEventListener('click', async () => {
            if (isProcessing) return;
            const name = photoName.value.trim();
            const date = photoDate.value;
            if (!name || !date || !capturedImage) {
                showToast('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!', true);
                return;
            }

            isProcessing = true;
            saveBtn.disabled = true;
            saveBtn.textContent = 'ƒêang l∆∞u...';

            try {
                // Upload ·∫£nh
                loadingEl.style.display = 'block';
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`images/${Date.now()}.png`);
                const response = await fetch(capturedImage);
                const blob = await response.blob();
                await imageRef.put(blob);
                const imageUrl = await imageRef.getDownloadURL();

                // L∆∞u metadata
                await db.collection('photos').add({
                    name,
                    date,
                    imageUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('‚úÖ L∆∞u ·∫£nh th√†nh c√¥ng!');
                resetForm();
                loadGallery(); // T·∫£i l·∫°i danh s√°ch
            } catch (err) {
                console.error(err);
                showToast('‚ùå L·ªói khi l∆∞u ·∫£nh: ' + err.message, true);
            } finally {
                isProcessing = false;
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ L∆∞u ·∫£nh';
                loadingEl.style.display = 'none';
            }
        });

        // X√≥a & l√†m l·∫°i
        deleteBtn.addEventListener('click', resetForm);

        function resetForm() {
            capturedImage = null;
            preview.style.display = 'none';
            saveForm.style.display = 'none';
            photoName.value = '';
            photoDate.value = '';
            cameraBtn.style.display = 'block';
        }

        // T·∫£i danh s√°ch ·∫£nh (c√≥ h·ªó tr·ª£ t√¨m ki·∫øm)
        async function loadGallery(searchQuery = '') {
            if (isProcessing) return;
            isProcessing = true;
            loadingEl.style.display = 'block';
            gallery.innerHTML = '';

            try {
                let query = db.collection('photos').orderBy('createdAt', 'desc');

                if (searchQuery) {
                    // T√¨m theo t√™n (kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng)
                    query = query.where('name', '>=', searchQuery.toLowerCase())
                                .where('name', '<=', searchQuery.toLowerCase() + '\uf8ff');
                    // Ho·∫∑c t√¨m theo ng√†y n·∫øu nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng yyyy-mm-dd
                    if (/^\d{4}-\d{2}-\d{2}$/.test(searchQuery)) {
                        query = db.collection('photos').where('date', '==', searchQuery).orderBy('createdAt', 'desc');
                    }
                }

                const snapshot = await query.get();
                allPhotos = [];
                snapshot.forEach(doc => {
                    allPhotos.push({ id: doc.id, ...doc.data() });
                });

                currentPage = 1;
                renderGallery();
                setupPagination();
            } catch (err) {
                showToast('‚ùå L·ªói t·∫£i danh s√°ch: ' + err.message, true);
            } finally {
                isProcessing = false;
                loadingEl.style.display = 'none';
            }
        }

        // Render ·∫£nh theo trang
        function renderGallery() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pagePhotos = allPhotos.slice(start, end);

            gallery.innerHTML = '';
            if (pagePhotos.length === 0) {
                gallery.innerHTML = '<p>Kh√¥ng c√≥ ·∫£nh n√†o.</p>';
                return;
            }

            pagePhotos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                const displayDate = photo.date ? photo.date : 'Kh√¥ng c√≥ ng√†y';
                item.innerHTML = `
                    <img src="${photo.imageUrl}" alt="${photo.name}" onerror="this.src='https://via.placeholder.com/80?text=Error'">
                    <div class="photo-info">
                        <strong>${photo.name}</strong><br>
                        Ng√†y: ${displayDate}
                    </div>
                    <div class="photo-actions">
                        <button onclick="deletePhoto('${photo.id}')">üóëÔ∏è X√≥a</button>
                    </div>
                `;
                gallery.appendChild(item);
            });
        }

        // Thi·∫øt l·∫≠p ph√¢n trang
        function setupPagination() {
            const totalPages = Math.ceil(allPhotos.length / itemsPerPage);
            paginationEl.innerHTML = '';

            if (totalPages <= 1) return;

            // N√∫t trang tr∆∞·ªõc
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚ùÆ';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderGallery();
                    setupPagination();
                }
            });
            paginationEl.appendChild(prevBtn);

            // C√°c n√∫t trang
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = 'active';
                    btn.disabled = true;
                    paginationEl.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.addEventListener('click', () => {
                        currentPage = i;
                        renderGallery();
                        setupPagination();
                    });
                    paginationEl.appendChild(btn);
                }
            }

            // N√∫t trang sau
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '‚ùØ';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderGallery();
                    setupPagination();
                }
            });
            paginationEl.appendChild(nextBtn);
        }

        // X√≥a ·∫£nh
        window.deletePhoto = async (id) => {
            if (isProcessing) return;
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?')) return;

            isProcessing = true;
            loadingEl.style.display = 'block';

            try {
                const doc = await db.collection('photos').doc(id).get();
                const data = doc.data();
                const imageRef = storage.refFromURL(data.imageUrl);
                await imageRef.delete();
                await db.collection('photos').doc(id).delete();

                showToast('‚úÖ ƒê√£ x√≥a ·∫£nh!');
                loadGallery(searchInput.value); // T·∫£i l·∫°i theo b·ªô l·ªçc hi·ªán t·∫°i
            } catch (err) {
                showToast('‚ùå L·ªói khi x√≥a: ' + err.message, true);
            } finally {
                isProcessing = false;
                loadingEl.style.display = 'none';
            }
        };

        // T√¨m ki·∫øm
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadGallery(searchInput.value.trim());
            }, 500); // debounce 0.5s
        });

        // L√†m m·ªõi danh s√°ch
        refreshBtn.addEventListener('click', () => {
            searchInput.value = '';
            loadGallery();
        });

        // T·ª± ƒë·ªông load l·∫ßn ƒë·∫ßu
        loadGallery();
    </script>
</body>
</html>
